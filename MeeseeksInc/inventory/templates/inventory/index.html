{% extends 'inventory/base.html' %} 
{#put this at the top so that the base template is "base.html"#}
{% load rest_framework %}
{% load static %}
{% load index %}
{% block content %}

<h2>All Inventory Items</h2>
<form id="search-form">
    <label>Included Tags:</label>
    <select id="included-tags" class="js-example-basic-multiple" multiple="multiple">
    {% for tag in tags %} 
    	<option value={{ tag.id }}>{{ tag.tag }}</option>
    {% endfor %}
	</select>
	<label>Excluded Tags:</label>
	<select id="excluded-tags" class="js-example-basic-multiple" multiple="multiple">
    {% for tag in tags %} 
    	<option value={{ tag.id }}>{{ tag.tag }}</option>
    {% endfor %}
	</select>
    <input type="submit"/>
</form>

<table id="inventory-search" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
<thead>
    <tr>
	<th>Item Name</th>
	<th>Quantity</th>
	<th>Item Model Number</th>
	<th>Item Description</th>
	{% for field in custom_fields%}
		<th>{{field.field_name}}</th>
	{% endfor %}
</tr>
</thead>
<tbody>
</tbody>
</table>

{% if request_list %}
	<h2>Requests made by you</h2>
	<ul class="nav nav-tabs">
	  <li><a href="#all" data-toggle="tab">All Requests</a></li>
	  <li><a href="#accepted" data-toggle="tab">Approved</a></li>
	  <li class="active"><a href="#pending" data-toggle="tab">Pending</a></li>
	  <li><a href="#denied" data-toggle="tab">Denied</a></li>
	</ul>
	<div class="tab-content">
        <div class="tab-pane" id="all">
			<table id="inventory-request-all" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
	        <thead>
	            <tr>
				<th>Request for</th>
				<th>Quantity</th>
				<th>Type</th>
				<th>Status</th>
				<th>Student Reason</th>
				<th>Admin Comment</th>
				<th>Time Requested</th>
			</tr>
	        </thead>
	        <tbody>
	        	{% for request in request_list %}
	        		<tr>
						<td><a href="{% url 'inventory:request_detail' request.request_id %}">{{ request.item_name }}</a></td>
						<td>{{ request.request_quantity }}</td>
						<td>{{ request.type }}</td>
						<td>{{ request.status }}</td>
						<td>{{ request.reason}}</td>
						<td>{{ request.comment }}</td>
						<td>
						  		<span style="display: none;">{{ request.time_requested|date:"c" }}</span>
								  {{ request.time_requested }}
						</td>
					</tr>
				{% endfor %}
	        </tbody>
	    </table>
        </div>
        <div class="tab-pane" id="accepted">
			<table id="inventory-request-approved" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
	        <thead>
	            <tr>
				<th>Request for</th>
				<th>Quantity</th>
				<th>Type</th>
				<th>Status</th>
				<th>Student Reason</th>
				<th>Admin Comment</th>
				<th>Time Requested</th>
			</tr>
	        </thead>
	        <tbody>
	        	{% for request in approved_request_list %}
	        		<tr>
						<td><a href="{% url 'inventory:request_detail' request.request_id %}">{{ request.item_name }}</a></td>
						<td>{{ request.request_quantity }}</td>
						<td>{{ request.type }}</td>
						<td>{{ request.status }}</td>
						<td>{{ request.reason}}</td>
						<td>{{ request.comment }}</td>
						<td>
						  		<span style="display: none;">{{ request.time_requested|date:"c" }}</span>
								  {{ request.time_requested }}
						</td>
					</tr>
				{% endfor %}
	        </tbody>
	    </table>
        </div>
        <div class="tab-pane active" id="pending">
			<table id="inventory-request-pending" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
	        <thead>
	            <tr>
				<th>Request for</th>
				<th>Quantity</th>
				<th>Type</th>
				<th>Status</th>
				<th>Student Reason</th>
				<th>Time Requested</th>
				<th>Actions</th>
			</tr>
	        </thead>
	        <tbody>
	        	{% for request in pending_request_list %}
	        		<tr>
						<td><a href="{% url 'inventory:request_detail' request.request_id %}">{{ request.item_name }}</a></td>
						<td>{{ request.request_quantity }}</td>
						<td>{{ request.type }}</td>
						<td>{{ request.status }}</td>
						<td>{{ request.reason}}</td>
						<td>
						  		<span style="display: none;">{{ request.time_requested|date:"c" }}</span>
								  {{ request.time_requested }}
						</td>
						<td>
							<a href="{% url 'inventory:request_edit_from_main' request.request_id %}" class="btn btn-primary">Edit</a>
							<a onclick="return confirm('Confirm request cancel?')" href="{% url 'inventory:request_cancel' request.request_id %}" class="btn btn-danger">Cancel</a>
						</td>
					</tr>
				{% endfor %}
	        </tbody>
	    </table>
        </div>
        <div class="tab-pane" id="denied">
			<table id="inventory-request-denied" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
	        <thead>
	            <tr>
				<th>Request for</th>
				<th>Quantity</th>
				<th>Type</th>
				<th>Status</th>
				<th>Student Reason</th>
				<th>Admin Comment</th>
				<th>Time Requested</th>
			</tr>
	        </thead>
	        <tbody>
	        	{% for request in denied_request_list %}
	        		<tr>
						<td><a href="{% url 'inventory:request_detail' request.request_id %}">{{ request.item_name }}</a></td>
						<td>{{ request.request_quantity }}</td>
						<td>{{ request.type }}</td>
						<td>{{ request.status }}</td>
						<td>{{ request.reason}}</td>
						<td>{{ request.comment }}</td>
						<td>
						  		<span style="display: none;">{{ request.time_requested|date:"c" }}</span>
								  {{ request.time_requested }}
						</td>
					</tr>
				{% endfor %}
	        </tbody>
	    </table>
        </div>
	</div>
{% endif %}

{# <a class="btn btn-info" href="{% url 'inventory:post_new_request' %}" role="button">Request an Item</a> #}

{########################## LOANS #####################}	
{% if loan_list %}
		<h2>Loaned to you</h2>
		<table id="inventory-loaned" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
		        <thead>
		            <tr>
					<th>Loan for</th>
					<th>Item Quantity </th>
					<th>Loaned to</th>
					<th>User Reason</th>
					<th>Admin Comment</th>
					<th>Time Loaned</th>
				</tr>
		        </thead>
		        <tbody>
		        	{% for loan in loan_list %}
		        		<tr>
							<td><a href="{% url 'inventory:loan_detail' loan.loan_id %}">{{ loan.item_name }}</a></td>
							<td>{{ loan.total_quantity }}</td>
							<td>{{ loan.user_name }}</td>
							<td>{{ loan.orig_request.reason}}</td>
							<td>{{ loan.comment}}</td>
							<td>
								  <span style="display: none;">{{ loan.time_loaned|date:"c" }}</span>
								  {{ loan.time_loaned }}
							</td>
						</tr>
					{% endfor %}
		        </tbody>
		    </table>
{% endif %}


{% if disbursed_list %}
	<h2>Disbursed to you</h2>
	<table id="inventory-disbursed" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
	        <thead>
	            <tr>
				<th>Item Name</th>
				<th>Quantity</th>
				<th>Disbursed by</th>
				<th>User Reason</th>
				<th>Admin Comment</th>
				<th>Time Disbursed</th>
			</tr>
	        </thead>
	        <tbody>
	        	{% for disbursed in disbursed_list %}
	        		<tr>
						<td>{{ disbursed.item_name }}</td>
						<td>{{ disbursed.total_quantity }}</td>
						<td>{{ disbursed.admin_name }}</td>
						<td>{{ disbursed.orig_request.reason}}</td>
						<td>{{ disbursed.comment}}</td>
						<td>
						  		<span style="display: none;">{{ disbursed.time_disbursed|date:"c" }}</span>
								  {{ disbursed.time_disbursed }}
							</td>
					</tr>
				{% endfor %}
	        </tbody>
	    </table>
{% endif %}
	
<script>
$(document).ready(function(){
	$('#inventory-item').dataTable();
    $('#inventory-request-all').dataTable({
        "order": [[ 5, "desc" ]]
    });
    $('#inventory-request-approved').dataTable({
        "order": [[ 5, "desc" ]]
    });
    $('#inventory-request-pending').dataTable({
        "order": [[ 5, "desc" ]]
    });
    $('#inventory-request-denied').dataTable({
        "order": [[ 5, "desc" ]]
    });
    $('#inventory-disbursed').dataTable({
        "order": [[ 5, "desc" ]]
    });
    $('#inventory-loaned').dataTable({
        "order": [[ 5, "desc" ]]
    });
});
</script>
<script>
$('#included-tags').select2(); // making multiple select
$('#excluded-tags').select2(); // making multiple select
get_search_data(); // initialize item data
$('#search-form').on('submit', function(event){
    event.preventDefault();
    console.log("form submitted!")  // sanity check
    get_search_data();
});

function get_search_data() {
	var data = '';
	var included_tags = $('#included-tags').select2('val');
	var excluded_tags = $('#excluded-tags').select2('val')
	if(included_tags) {
		for(i in included_tags) {
			data += 'included_tags=' + included_tags[i]+'&';
		}
	}
	if(excluded_tags) { 
		for(i in excluded_tags) {
			data += 'excluded_tags=' + excluded_tags[i] + '&';
		}
	}
	console.log(data);
    $.ajax({
        url : '{% url 'inventory:api_item_list' %}',
        type : "GET", // http method
        data : data,
        success : function(json) {
            $('#item_name').val(''); // remove the value from the input
            console.log(json); // log the returned json to the console
        	$('#inventory-search').dataTable().fnClearTable();
        	var numCustomFields = {{ custom_fields|length }}
        	var djangoCustomFieldNameList = [];
			{% for field in custom_fields %} 
				djangoCustomFieldNameList.push("{{ field.field_name }}");
			{% endfor %}
			
         	for(i in json) {
         		var dataTableData = [
			        "<a href=\"" + "/item"+"/"+json[i].item_id+"\">"+json[i].item_name+"</a></td>",
			        json[i].quantity,
			        json[i].model_number,
			        json[i].description
			         ];
			    var numCustomFieldsAvailable = json[i].values_custom_field.length;
			    if(numCustomFieldsAvailable === 0) {
			    	for(count = 0; count<numCustomFields; count++) {
			    		dataTableData.push('');
			    	}
			    } else {
			    	var customFieldArr = Array(numCustomFields).fill('');
			    	for(count = 0; count<numCustomFieldsAvailable; count++) {
			    		var custom_field_object = json[i].values_custom_field[count];
			    		var field = custom_field_object.field;
						var indexOfField = djangoCustomFieldNameList.indexOf(field.field_name);
						if(indexOfField == -1) {
			    			continue;
			    		}
			    		if (field.field_type == "Short") {
							customFieldArr[indexOfField] = custom_field_object.field_value_short_text;
						} else if(field.field_type == "Long") {
							customFieldArr[indexOfField] = custom_field_object.field_value_long_text;
						} else if(field.field_type == "Int") {
							if(custom_field_object.field_value_integer) {
								customFieldArr[indexOfField] = custom_field_object.field_value_integer;
							}
						} else if(field.field_type == "Float") {
							if(custom_field_object.field_value_floating) {
								customFieldArr[indexOfField] = custom_field_object.field_value_floating;
							}
						}
			    	}
			    	dataTableData.push.apply(dataTableData, customFieldArr);
			    }
         		$('#inventory-search').dataTable().fnAddData(dataTableData);
        	}
        },
        error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
        }
    });
};

$(document).ready(function(){
	    $('#inventory-search').dataTable();
	});
</script>
{% endblock %}
