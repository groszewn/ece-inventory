{% extends 'custom_admin/base.html' %} 
{% load static %}
{#put this at the top so that the base template is "base.html"#}

{% block content %}
{########################## MESSAGES (SUCCESS / ERRORS) #####################}
{#{% if messages %}#}
{#<ul class="messages">#}
{#    {% for message in messages %}#}
{#    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>#}
{#    {% endfor %}#}
{#</ul>#}
{#{% endif %}#}

{########################## ALL USERS ##########################}

<h2>All Users</h2>

{% if user %}
	<table id="user-table" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
        <thead>
            <tr>
            <th>Username</th>
			<th>First Name</th>
			<th>Last Name</th>
			<th>Email</th>
			<th>Staff Status</th>
			<th>Active User</th>
			<th>Actions</th>
		</tr>
        </thead>
        
        <tbody>
            {% for user in user_list %}
				<tr>
					<td>{{ user.username }}</a></td>
					<td>{{ user.first_name }}</td>
					<td>{{ user.last_name }}</td>
					<td>{{ user.email }}</td>
					<td>{{ user.is_staff }}</td>
					<td>{{ user.is_active }}</td>
					<td>
						<a href="{% url 'custom_admin:edit_permission' user.username %}" class="btn btn-warning">Edit User</a>
					</td>	
				</tr>
			{% endfor %}
        </tbody>
    </table>
{% endif %}



{########################## ALL ITEMS ##########################}


{% if item_list %}

	<h2>All available items</h2>
	<form method="POST" class="post-form">{% csrf_token %}
	 {{ form.Tag2Include.label }} {{ form.Tag2Include }}
	 {{ form.Tag2Exclude.label }} {{ form.Tag2Exclude }}
	<button type="submit" class="save btn btn-default">Tag Filter</button>
	<a class="btn btn-default" href="{% url 'inventory:index' %}" role="button">Cancel Filter</a>
	</form>
	<table id="inventory-item" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
        <thead>
            <tr>
			<th>Item Name</th>
			<th># Item</th>
			<th>Item Location</th>
			<th>Item Model Number</th>
			<th>Item Description</th>
		</tr>
        </thead>
        {% block item_filter_table%}
        <tbody>
            {% for item in item_list %}
				<tr>
					<td><a href="{% url 'inventory:detail' item.item_id %}">{{ item.item_name }}</a></td>
					<td>{{ item.quantity }}</td>
					<td>{{ item.location }}</td>
					<td>{{ item.model_number }}</td>
					<td>{{ item.description }}</td>
				</tr>
			{% endfor %}
        </tbody>
        {% endblock %}
    </table>

{########################## ALL REQUESTS, SORTED BY ITEM #####################}

<h2>Requests made by users</h2>

	{% if request_list %}
		<ul class="nav nav-tabs">
		  <li><a href="#all" data-toggle="tab">All Requests</a></li>
		  <li><a href="#accepted" data-toggle="tab">Approved</a></li>
		  <li class="active"><a href="#pending" data-toggle="tab">Pending</a></li>
		  <li><a href="#denied" data-toggle="tab">Denied</a></li>
		</ul>
		
		<div class="tab-content">
	        <div class="tab-pane" id="all">
	            <table border="0" cellspacing="5" cellpadding="5">
			        <tbody>
				        <tr>
				            <td>Tags:</td>
				            <td><input type="text" id="tag" name="tag"></td>
				        </tr>
		    		</tbody>
		    	</table>
				<table id="inventory-request-all" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
		        <thead>
		            <tr>
					<th>Request</th>
					<th># Item</th>
					<th>Status</th>
					<th>Requested by</th>
					<th>Student Reason</th>
					<th>Admin Comment</th>
				</tr>
		        </thead>
		        <tbody>
		        	{% for request in request_list %}
		        		<tr>
							<td><a href="{% url 'inventory:request_detail' request.request_id %}">Request for {{ request.item_name }}:</a></td>
							<td>{{ request.request_quantity }}</td>
							<td>{{ request.status }}</td>
							<td>{{ request.user_id }}</td>
							<td>{{ request.reason}}</td>
							<td>{{ request.comment }}</td>
						</tr>
					{% endfor %}
		        </tbody>
		    </table>
	        </div>
	        
	        <div class="tab-pane" id="accepted">
	            <table border="0" cellspacing="5" cellpadding="5">
			        <tbody>
				        <tr>
				            <td>Tags:</td>
				            <td><input type="text" id="tag" name="tag"></td>
				        </tr>
		    		</tbody>
		    	</table>
				<table id="inventory-request-approved" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
		        <thead>
		            <tr>
					<th>Request</th>
					<th># Item</th>
					<th>Status</th>
					<th>Requested by</th>
					<th>Student Reason</th>
					<th>Admin Comment</th>
				</tr>
		        </thead>
		        <tbody>
		        	{% for request in approved_request_list %}
		        		<tr>
							<td><a href="{% url 'inventory:request_detail' request.request_id %}">Request for {{ request.item_name }}:</a></td>
							<td>{{ request.request_quantity }}</td>
							<td>{{ request.status }}</td>
							<td>{{ request.user_id }}</td>
							<td>{{ request.reason}}</td>
							<td>{{ request.comment }}</td>
						</tr>
					{% endfor %}
		        </tbody>
		    </table>
	        </div>
	        
	        <div class="tab-pane active" id="pending">
	            <table border="0" cellspacing="5" cellpadding="5">
			        <tbody>
				        <tr>
				            <td>Tags:</td>
				            <td><input type="text" id="tag" name="tag"></td>
				        </tr>
		    		</tbody>
		    	</table>
				<table id="inventory-request-pending" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
		        <thead>
		            <tr>
					<th>Request</th>
					<th># Item</th>
					<th>Status</th>
					<th>Requested by</th>
					<th>Student Reason</th>
					<th>Admin Comment</th>
					<th>Actions</th>
				</tr>
		        </thead>
		        <tbody>
		        	{% for request in pending_request_list %}
		        		<tr>
							<td><a href="{% url 'inventory:request_detail' request.request_id %}">Request for {{ request.item_name }}:</a></td>
							<td>{{ request.request_quantity }}</td>
							<td>{{ request.status }}</td>
							<td>{{ request.user_id }}</td>
							<td>{{ request.reason}}</td>
							<td>{{ request.comment }}</td>
							<td>
								{% block comment_accept %}
								<a id = "accept" request-id="{{ request.request_id }}" class="accept btn btn-success">Approve</a>
								{% endblock comment_accept %}
								{% block comment_deny %}
								<a id = "deny" request-id="{{ request.request_id }}" class="deny btn btn-warning">Deny</a>	
								{% endblock comment_deny %}
								<a href="{% url 'inventory:request_edit' request.request_id %}" class="btn btn-info">Edit</a>
								<a onclick="return confirm('Confirm request cancel?')" href="{% url 'inventory:request_cancel' request.request_id %}" class="btn btn-danger">Cancel</a>
							</td>
						</tr>
					{% endfor %}
		        </tbody>
		    </table>
	        </div>
	        
	        <div class="tab-pane" id="denied">
	            <table border="0" cellspacing="5" cellpadding="5">
			        <tbody>
				        <tr>
				            <td>Tags:</td>
				            <td><input type="text" id="tag" name="tag"></td>
				        </tr>
		    		</tbody>
		    	</table>
				<table id="inventory-request-denied" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
		        <thead>
		            <tr>
					<th>Request</th>
					<th># Item</th>
					<th>Status</th>
					<th>Request by</th>
					<th>Student Reason</th>
					<th>Admin Comment</th>
				</tr>
		        </thead>
		        <tbody>
		        	{% for request in denied_request_list %}
		        		<tr>
							<td><a href="{% url 'inventory:request_detail' request.request_id %}">Request for {{ request.item_name }}:</a></td>
							<td>{{ request.request_quantity }}</td>
							<td>{{ request.status }}</td>
							<td>{{ request.user_id }}</td>
							<td>{{ request.reason}}</td>
							<td>{{ request.comment }}</td>
						</tr>
					{% endfor %}
		        </tbody>
		    </table>
	        </div>
	        
		</div>
	{% else %}
		<p class="lead" style="padding: 15px 15px">No outstanding Requests.</p>
	{% endif %}
	
{#{% for request_tuple in request_list %}#}
{#	<h3>Item Name: {{ request_tuple.0 }}</h3>#}
{#	<ul>#}
{#		{% for request in request_tuple.1 %}#}
{#			<li> <a href="{% url 'inventory:request_detail' request.request_id %}" class="top-menu"><b>({{ request.user_id }})</b> Request for {{ request.item_name }}: </a> Quantity= {{ request.request_quantity }} Status= {{ request.status }}</li>#}
{#			{% if request.status == "Pending" %}#}
{#				Reason: {{ request.reason }}#}
{#				{% block comment_accept %}#}
{#				<a id = "accept" request-id="{{ request.request_id }}" class="accept">Approve this request<span class="glyphicon glyphicon-plus"></span></a>#}
{#				{% endblock comment_accept %}#}
{#				{% block comment_deny %}#}
{#				<a id = "deny" request-id="{{ request.request_id }}" class="deny">Deny this request<span class="glyphicon glyphicon-plus"></span></a>	#}
{#				{% endblock comment_deny %}#}
{#			{% endif %}#}
{#		{% endfor %}#}
{#	</ul>#}
{#{% endfor %}#}

	<a class="btn btn-default" href="{% url 'custom_admin:approve_all_requests' %}" role="button">Approve all requests</a>
	<a class="btn btn-default" href="{% url 'custom_admin:deny_all_requests' %}" role="button">Deny all requests</a>

{########################## DISBURSEMENTS #####################}
	{% if disbursed_list %}
		<h2>Disbursed by you</h2>
		<table id="inventory-disbursed" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
		        <thead>
		            <tr>
					<th>Item Name</th>
					<th># Item</th>
					<th>Disbursed to</th>
					<th>Admin Comment</th>
					<th>Time Disbursed</th>
				</tr>
		        </thead>
		        <tbody>
		        	{% for disbursed in disbursed_list %}
		        		<tr>
							<td>{{ disbursed.item_name }}</td>
							<td>{{ disbursed.total_quantity }}</td>
							<td>{{ disbursed.user_name }}</td>
							<td>{{ disbursed.comment}}</td>
							<td>{{ disbursed.time_disbursed }}</td>
						</tr>
					{% endfor %}
		        </tbody>
		    </table>
	{% endif %}

	{#<a href="{% url 'custom_admin:post_new_disburse' %}" class="top-menu">Directly disburse Items to Users here<span class="glyphicon glyphicon-plus"></span></a>	#}
		{% block modal %}
			<button id="comment-button" class="btn btn-large">Directly disburse Items to Users here</button>
		{% endblock modal %}


{% endif %}

{############################# REQUEST DENIAL COMMENT MODAL LOGIC ##############################}
<div id="form-modal-deny" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Comment for Request Deny</h4>
            </div>
            <div id="form-modal-body-deny" class="modal-body">
                <p>One fine body&hellip;</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal --> 
{% block js-deny %}
<script src="{% static "js/bootstrap.min.js" %}"></script>
<script src="{% static "js/jquery.min.js" %}"></script>
<script>
    $('.deny').click(function() {
    	request_id = $(this).attr("request-id"); // should give me request_id to pass into modal / form
        $('#form-modal-body-deny').load(('request/deny/addcomment/'+request_id), function () {
        	$('#formID-comment-deny').attr("request-comment", request_id);
            $('#form-modal-deny').modal('toggle');
        });
    });
</script>
{% endblock js-deny %}

{############################# REQUEST ACCEPT COMMENT MODAL LOGIC ##############################}
<div id="form-modal-accept" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Comment for Request Accept</h4>
            </div>
            <div id="form-modal-body-accept" class="modal-body">
                <p>One fine body&hellip;</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal --> 
{% block js-approve %}
<script src="{% static "js/bootstrap.min.js" %}"></script>
<script src="{% static "js/jquery.min.js" %}"></script>
<script>
    $('.accept').click(function() {
    	request_id = $(this).attr("request-id"); // should give me request_id to pass into modal / form
        $('#form-modal-body-accept').load(('request/accept/addcomment/'+request_id), function () {
        	$('#formID-comment-accept').attr("request-comment", request_id);
            $('#form-modal-accept').modal('toggle');
        });
    });
</script>
{% endblock js-approve %}

{############################# DIRECT DISBURSEMENT MODAL LOGIC ##############################}
<div id="form-modal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Direct Disbursement</h4>
            </div>
            <div id="form-modal-body" class="modal-body">
                <p>One fine body&hellip;</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal --> 
{% block js %}
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script>
    $('#comment-button').click(function() {
        $('#form-modal-body').load('disburse/item', function () {
            $('#form-modal').modal('toggle');
        });
    });
</script>
{% endblock js %}
{########### TODO: FIGURE OUT WHY I NEED THESE JAVASCRIPT FILES HERE FOR IT TO LOAD DATATABLES PROPERLY #######}
<link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="http://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css"></style>
<script type="text/javascript" src="http://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"></script>
 
 <script>
	$(document).ready(function(){
		$.fn.dataTable.ext.search.push(
		    function( settings, data, dataIndex, originalData ) {
		    	if (settings.nTable.id !== 'inventory-disbursed' && settings.nTable.id !== 'user-table') { // only do this for all tables but disbursed (no tags)
		    		var tag = $('#tag').val();
		    		id = originalData[0].split("\"")[1].split("/")[2]; 
		        	console.log(id);
       			}
		    	// first get tag for this data row
		       	
		        return true;
		    }
		);
	    var itemTable = $('#inventory-item').dataTable();
	     // Event listener to the two range filtering inputs to redraw on input
	    $('#tag, #min, max').keyup( function() {
	        itemTable.draw();
	    } );
	});
	$(document).ready(function(){
	    $('#inventory-request-all').dataTable();
	    $('#inventory-request-approved').dataTable();
	    $('#inventory-request-pending').dataTable();
	    $('#inventory-request-denied').dataTable();
	    $('#inventory-disbursed').dataTable();
	    $('#user-table').dataTable();
	});
	</script>

{% endblock %}


